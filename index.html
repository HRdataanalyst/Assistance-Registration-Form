<!doctype html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>แบบฟอร์มลงทะเบียนผู้ประสบอุทกภัย 2568</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ฟอนต์ Prompt -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after {
  box-sizing: border-box;
}

/* หน้าเว็บสำหรับมือถือ ให้เต็มสูงเท่าหน้าจอ และไม่มีพื้นหลังสีเทา */
html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  overflow-y: auto;
  font-family: "Prompt", sans-serif;
  background-color: #ffffff;   /* พื้นหลังขาวล้วน */
  font-size: 16px;
  height: 100%;                /* ให้ body สูงเท่าหน้าจอ */
}

/* ป้องกันข้อความหรือเนื้อหายาว ๆ ล้นออกจอ */
body {
  word-wrap: break-word;
}

/* input/label */
input,
select,
textarea,
button,
label {
  font-size: 1rem;
}

/* ปรับขนาด select (ช่องเพศ) ให้สูงเท่าช่องอื่นบนมือถือ */
select {
  -webkit-appearance: none;   /* ตัดสไตล์ native บน iOS */
  appearance: none;

  width: 100%;
  padding: 0.65rem 0.75rem;   /* ให้หนาขึ้นเท่าช่อง input */
  border-radius: 0.25rem;     /* มุมโค้งเหมือนช่องอื่น */
  border: 1px solid #cbd5e1;
  height: 44px;               /* ฟิกความสูงเท่าช่องอื่น */
  line-height: 1.25rem;
  background-color: #ffffff;
  box-sizing: border-box;
}

/* ปรับช่องวันเกิด (input type="date") ให้สูงเท่าช่องอื่น และชิดซ้าย */
input[type="date"] {
  width: 100%;
  padding: 0.65rem 0.75rem;     /* ให้ padding เท่าช่อง text */
  border-radius: 0.5rem;        /* มุมโค้งเท่าช่องอื่น */
  border: 1px solid #cbd5e1;    /* สีเส้นขอบเหมือนช่องอื่น */
  min-height: 44px;             /* บังคับความสูงขั้นต่ำให้ไม่เตี้ย */
  line-height: 1.25rem;
  text-align: left;             /* ให้ข้อความวันที่ชิดซ้าย */
  box-sizing: border-box;
}

/* เว้นระยะคำถาม */
.form-group {
  margin-bottom: 1.5rem;
}

/* หัวข้อของแต่ละส่วน */
.section-block {
  margin-top: 2rem;
  margin-bottom: 1rem;
  padding-bottom: 0.25rem;
  border-bottom: 2px solid #e2e8f0;
}

.id-card-input {
  letter-spacing: 0.05em;
}

/* container หลักของเว็บ */
.app-container {
  width: 100%;
  margin: 0 auto;
  min-height: 100vh;    /* สูงอย่างน้อยเท่าหน้าจอ */
  display: block;
}

/* container ของแต่ละหน้า: ให้เต็มจอ แต่เลื่อนได้ถ้าฟอร์มยาว */
.page-container {
  width: 100%;
  margin: 0 auto;
  padding: 0 16px 16px; /* ลด padding ให้พอดีหน้าจอมือถือ */
  min-height: 100vh;    /* อย่างน้อยเท่าความสูงจอ */
  display: flex;
  flex-direction: column;
}
    /* ปรับสไตล์ช่องวันเกิดให้เหมือนช่องอื่น และชิดซ้ายบนมือถือ */
  input[type="date"] {
    -webkit-appearance: none;
    appearance: none;
    background-color: #ffffff;
    border: 1px solid #cbd5e1;
    border-radius: 0.25rem;
    padding: 0.5rem 0.75rem;
    width: 100%;
    text-align: left;
    }
  </style>

  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
</head>

<body>
  <div class="app-container">

    <!-- Popup แจ้งผลสำเร็จ -->
    <div id="successPopup"
         style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.4);
                backdrop-filter: blur(2px); z-index: 9999;"
         class="flex items-center justify-center">
      <div style="background:white; width: 80%; max-width:320px; border-radius:12px; padding:20px; text-align:center;">
        <h3 style="font-size:1rem; color:#15803d; font-weight:600; margin-bottom:10px;">
          ✓ ลงทะเบียนสำเร็จ
        </h3>
        <p style="font-size:0.85rem; color:#475569; margin-bottom:16px;">
          ระบบได้บันทึกข้อมูลของคุณเรียบร้อยแล้ว
        </p>
        <button id="popupCloseBtn"
                style="background:#15803d; color:white; width:100%; padding:10px; border-radius:6px;">
          ปิด
        </button>
      </div>
    </div>

    <!-- Home Page -->
    <div id="home-page"
     class="page-container w-full flex flex-col items-center justify-center text-center py-10">

      <!-- Logo -->
      <img src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png"
           alt="BJC Big C Logo"
           class="mx-auto mb-6"
           style="max-width: 260px; height: auto;"
           onerror="this.style.display='none';">

      <!-- Title -->
      <h1 class="font-bold mb-3" style="color: #15803d; font-size: 1.6rem;">
        แบบฟอร์มลงทะเบียนผู้ประสบอุทกภัย 2568
      </h1>
      <p class="mb-8" style="color: #166534; font-size: 1rem;">
        จังหวัดสงขลา
      </p>

      <!-- Start Button -->
      <button id="start-register-btn"
              class="w-full max-w-xs py-3 rounded font-medium"
              style="background-color: #15803d; color: white; font-size: 1.05rem;">
        ลงทะเบียน
      </button>
    </div>

    <!-- PDPA Page -->
    <div id="pdpa-page"
     class="page-container w-full py-6"
     style="display: none;">

        <h1 id="pdpa-title" class="font-bold mb-4"
            style="color: #1e293b; font-size: 1.1rem; text-align: center;">
          นโยบายการคุ้มครองข้อมูลส่วนบุคคล
        </h1>

        <!-- กล่องข้อความยาว -->
        <div class="mb-5"
             style="background-color: #f8fafc; padding: 16px; border-radius: 8px;
                    border: 1px solid #e2e8f0; line-height: 1.8; font-size: 0.95rem; color: #475569; width:100%;">
          <p class="mb-3">
            องค์กรของเราให้ความสำคัญอย่างยิ่งต่อการคุ้มครองข้อมูลส่วนบุคคลของท่าน
            การเก็บรวบรวม ใช้ และเปิดเผยข้อมูลส่วนบุคคลจะดำเนินการเพื่อวัตถุประสงค์ในการให้ความช่วยเหลือผู้ประสบภัยน้ำท่วมเท่านั้น
          </p>

          <p class="mb-3">
            <strong>วัตถุประสงค์ในการใช้ข้อมูล:</strong><br>
            - ใช้สำหรับประสานงานการช่วยเหลือผู้ประสบภัย<br>
            - ใช้ในการจัดลำดับความเร่งด่วนในการช่วยเหลือ<br>
          </p>

          <p class="mb-3">
            <strong>การเปิดเผยข้อมูล:</strong><br>
            ข้อมูลของท่านจะไม่ถูกส่งต่อไปยังบุคคลภายนอก
            เว้นแต่เป็นหน่วยงานที่เกี่ยวข้องกับการให้ความช่วยเหลือ
            และจำเป็นต้องใช้ข้อมูลเพื่อประโยชน์ของผู้ประสบภัยเท่านั้น
          </p>

          <p class="mb-3">
            <strong>การจัดเก็บและรักษาความปลอดภัยของข้อมูล:</strong><br>
            ข้อมูลของท่านจะถูกจัดเก็บอย่างปลอดภัย
            และจำกัดสิทธิ์การเข้าถึงเฉพาะผู้ที่เกี่ยวข้องเท่านั้น
          </p>

          <p class="mb-0">
            หากท่านไม่ยินยอมให้ใช้ข้อมูล ระบบจะไม่สามารถดำเนินการลงทะเบียนได้
            การอยู่ในขั้นตอนต่อไปถือว่าท่านยอมรับตามนโยบายนี้แล้ว
          </p>
        </div>

        <!-- ช่องติ๊กยินยอม -->
        <div class="mb-4">
          <label class="flex items-start cursor-pointer">
            <input type="checkbox" id="consent-checkbox" class="mt-1 mr-2"
                   style="width: 18px; height: 18px; cursor: pointer;">
            <span style="color: #334155; font-size: 0.95rem; line-height: 1.5;">
              ข้าพเจ้าได้อ่านและยอมรับนโยบายการคุ้มครองข้อมูลส่วนบุคคลดังกล่าว
            </span>
          </label>
        </div>

        <!-- Error: ยังใช้เหมือนเดิม -->
        <div id="pdpa-error" class="mb-3 p-2 rounded"
             style="background-color: #fee2e2; color: #b91c1c; display: none; font-size: 0.85rem;">
          กรุณายอมรับนโยบายก่อนดำเนินการต่อ
        </div>

        <!-- Error เผื่อใช้กรณีระบบมีปัญหาในหน้า PDPA (ถ้าอยากใช้ภายหลัง) -->
        <div id="pdpa-system-error" class="mb-3 p-2 rounded"
             style="background-color: #fee2e2; color: #991b1b; display: none; font-size: 0.75rem;">
          เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง
        </div>

        <!-- ปุ่มย้อนกลับ + ปุ่มยอมรับ (ปุ่มนี้จะเห็นตลอด แต่ disabled ก่อนติ๊ก) -->
        <div class="flex gap-2 mt-2">
          <button id="back-home-btn"
                  class="flex-1 py-2 px-3 rounded font-medium"
                  style="background-color: #e2e8f0; color: #475569;">
            ย้อนกลับ
          </button>
          <button id="consent-btn"
                  class="flex-1 py-2 px-3 rounded font-medium"
                  style="background-color: #15803d; color: white; opacity: 0.5; cursor: not-allowed;"
                  disabled>
            ยอมรับและดำเนินการต่อ
          </button>
        </div>

    </div>

    <!-- Registration Page -->
    <div id="registration-page"
     class="page-container w-full py-6 pb-20"
     style="display: none;">

        <!-- Logo Section -->
        <div class="mb-3"
             style="background: linear-gradient(180deg, rgba(21, 128, 61, 0.15) 0%, rgba(255, 255, 255, 0.15) 100%);
                    padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <div class="flex items-center mb-2">
            <img src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png"
                 alt="BJC Big C Logo"
                 style="max-width: 80px; height: auto; margin-right: 12px;"
                 onerror="this.style.display='none';">
            <p id="province-text" style="color: #166534; font-size: 0.9rem;">
              จังหวัดสงขลา
            </p>
          </div>
          <h1 id="form-title" class="font-bold text-center"
              style="color: #15803d; font-size: 1.4rem;">
            แบบฟอร์มลงทะเบียนผู้ประสบอุทกภัย 2568
          </h1>
        </div>

        <!-- Info Banner -->
        <div class="mb-4 p-2 rounded"
             style="background-color: #fef3c7;">
          <p style="color: #92400e; font-size: 0.95rem; line-height: 1.6;">
            <strong>คำแนะนำ:</strong>
            กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง เพื่อให้ทีมงานสามารถประสานงานและส่งความช่วยเหลือถึงท่านได้อย่างรวดเร็ว
          </p>
        </div>

        <form id="registration-form">
          <!-- Personal Info Section -->

          <div class="section-block">
  <h2 class="font-bold mb-0" style="color: #15803d; font-size: 1.1rem;">
    ข้อมูลทั่วไปของผู้ประสบภัย
  </h2>
</div>

<!-- ชื่อ -->
<div class="mb-3 form-group">
  <label for="name" class="block mb-1 font-medium" style="color: #334155;">
    ชื่อ <span style="color: #ef4444;">*</span>
  </label>
  <input type="text" id="name" required
         class="w-full border rounded p-2"
         style="border-color: #cbd5e1;"
         placeholder="กรอกชื่อ">
</div>

<!-- นามสกุล -->
<div class="mb-3 form-group">
  <label for="surname" class="block mb-1 font-medium" style="color: #334155;">
    นามสกุล <span style="color: #ef4444;">*</span>
  </label>
  <input type="text" id="surname" required
         class="w-full px-3 py-2 border rounded"
         style="border-color: #cbd5e1;"
         placeholder="กรอกนามสกุล">
</div>

<!-- อายุ -->
<div class="mb-3 form-group">
  <label for="age" class="block mb-1 font-medium" style="color: #334155;">
    อายุ <span style="color: #ef4444;">*</span>
  </label>
  <input type="number" id="age" required
         class="w-full px-3 py-2 border rounded"
         style="border-color: #cbd5e1;"
         placeholder="กรอกอายุ (ปี)"
         min="0" max="120">
</div>

<!-- เพศ -->
<div class="mb-3 form-group">
  <label for="gender" class="block mb-1 font-medium" style="color: #334155;">
    เพศ <span style="color: #ef4444;">*</span>
  </label>
  <select id="gender" required
          class="w-full px-3 py-2 border rounded bg-white"
          style="border-color: #cbd5e1;">
    <option value="">-- เลือกเพศ --</option>
    <option value="ชาย">ชาย</option>
    <option value="หญิง">หญิง</option>
    <option value="อื่นๆ">อื่นๆ</option>
  </select>
</div>

<!-- หมายเลขบัตรประชาชน -->
<div class="mb-3 form-group">
  <label for="id-card" class="block mb-1 font-medium" style="color: #334155;">
    หมายเลขบัตรประชาชน <span style="color: #ef4444;">*</span>
  </label>
  <input type="text" id="id-card" required
         class="w-full px-3 py-2 border rounded id-card-input"
         style="border-color: #cbd5e1;"
         placeholder="X-XXXX-XXXXX-XX-X"
         maxlength="17">
</div>

<!-- เบอร์ติดต่อ -->
<div class="mb-3 form-group">

  <label for="phone" class="block mb-1 font-medium" style="color: #334155;">
    เบอร์ติดต่อ <span style="color: #ef4444;">*</span>
  </label>

  <input
    type="tel"
    id="phone"
    required
    class="w-full px-3 py-2 border rounded"
    style="border-color: #cbd5e1;"
    placeholder="xxx-xxx-xxxx"
    maxlength="12"
    pattern="\d{3}-\d{3}-\d{4}"
    title="กรุณากรอกเป็นรูปแบบ xxx-xxx-xxxx เช่น 081-234-5678"
  >

</div>

<!-- ช่องทางติดต่ออื่น (Line / Facebook / ญาติ) -->
<div class="mb-3 form-group">
  <label for="contact-other" class="block mb-1 font-medium" style="color: #334155;">
    ช่องทางติดต่ออื่น (Line / Facebook / ญาติ)
  </label>
  <input type="text" id="contact-other"
         class="w-full px-3 py-2 border rounded"
         style="border-color: #cbd5e1;"
         placeholder="เช่น Line ID, Facebook หรือเบอร์โทรญาติ">
</div>
          
          <!-- Address Section -->
          <div class="section-block">
            <h2 class="font-bold mb-0" style="color: #15803d; font-size: 1.1rem;">
              ข้อมูลที่อยู่ / พื้นที่ประสบภัย
            </h2>
          </div> 

          <!-- บ้านเลขที่ -->
          <div class="mb-3 form-group">
            <label for="house-no" class="block mb-1 font-medium" style="color: #334155;">
              บ้านเลขที่ <span style="color: #ef4444;">*</span>
            </label>
            <input type="text" id="house-no" required
                   class="w-full px-3 py-2 border rounded"
                   style="border-color: #cbd5e1;"
                   placeholder="บ้านเลขที่ / เลขที่ห้อง / เลขที่อาคาร">
          </div>

          <!-- หมู่บ้าน / ชุมชน -->
          <div class="mb-3 form-group">
            <label for="village" class="block mb-1 font-medium" style="color: #334155;">
              หมู่บ้าน / ชุมชน
            </label>
            <input type="text" id="village"
                   class="w-full px-3 py-2 border rounded"
                   style="border-color: #cbd5e1;"
                   placeholder="เช่น หมู่บ้านตัวอย่าง หรือชื่อชุมชน">
          </div>

          <!-- ตำบล -->
          <div class="mb-3 form-group">
            <label for="subdistrict" class="block mb-1 font-medium" style="color: #334155;">
              ตำบล <span style="color: #ef4444;">*</span>
            </label>
            <input type="text" id="subdistrict" required list="subdistrict-list"
                   class="w-full px-3 py-2 border rounded"
                   style="border-color: #cbd5e1;"
                   placeholder="ค้นหาหรือเลือกตำบล">
            <datalist id="subdistrict-list">
              <!-- datalist จะถูกเติมอัตโนมัติจาก locationData -->
            </datalist>
          </div>

          <!-- อำเภอ -->
          <div class="mb-3 form-group">
            <label for="district" class="block mb-1 font-medium" style="color: #334155;">
              อำเภอ <span style="color: #ef4444;">*</span>
            </label>
            <input type="text" id="district" required list="district-list"
                   class="w-full px-3 py-2 border rounded"
                   style="border-color: #cbd5e1;"
                   placeholder="ค้นหาหรือเลือกอำเภอ">
            <datalist id="district-list">
              <!-- datalist จะถูกเติมอัตโนมัติจาก locationData -->
            </datalist>
          </div>

          <!-- จังหวัด (auto เป็นสงขลา) -->
          <div class="mb-3 form-group">
            <label for="province" class="block mb-1 font-medium" style="color: #334155;">
              จังหวัด <span style="color: #ef4444;">*</span>
            </label>
            <input type="text" id="province" required
                   class="w-full px-3 py-2 border rounded bg-gray-50"
                   style="border-color: #cbd5e1;"
                   value="สงขลา"
                   readonly>
          </div>

          <!-- รหัสไปรษณีย์ -->
          <div class="mb-3 form-group">
            <label for="postal-code" class="block mb-1 font-medium" style="color: #334155;">
              รหัสไปรษณีย์ <span style="color: #ef4444;">*</span>
            </label>
            <input
              type="text"
              id="postal-code"
              required
              list="postal-list"
              class="w-full px-3 py-2 border rounded"
              style="border-color: #cbd5e1;"
              placeholder="กรอกรหัสไปรษณีย์หรือเลือกจากรายการ"
            >
            <datalist id="postal-list">
              <!-- จะถูกเติมอัตโนมัติจาก locationData ตามเดิม -->
            </datalist>
          </div>

          <!-- สถานะพื้นที่ตอนนี้ -->
          <div class="mb-3 form-group">
            <label for="area-status" class="block mb-1 font-medium" style="color: #334155;">
              สถานะพื้นที่ตอนนี้ <span style="color: #ef4444;">*</span>
            </label>
            <select id="area-status" required
                    class="w-full px-3 py-2 border rounded bg-white"
                    style="border-color: #cbd5e1;">
              <option value="">-- เลือกสถานะพื้นที่ --</option>
              <option value="น้ำยังท่วม">น้ำยังท่วม</option>
              <option value="น้ำลดแล้ว">น้ำลดแล้ว</option>
              <option value="เข้าไม่ได้">เข้าไม่ได้</option>
              <option value="เข้าถึงได้บางส่วน">เข้าถึงได้บางส่วน</option>
            </select>
          </div>

          <!-- Household Members Section -->
          <div class="section-block">
            <h2 class="font-bold mb-0" style="color: #15803d; font-size: 1.1rem;">
              จำนวนสมาชิกในบ้าน
            </h2>
          </div>

          <!-- จำนวนสมาชิกทั้งหมด -->
          <div class="mb-3 form-group">
            <label for="members-total" class="block mb-1 font-medium" style="color: #334155;">
              จำนวนสมาชิกทั้งหมดในบ้าน
            </label>
            <select id="members-total"
                    class="w-full px-3 py-2 border rounded bg-white"
                    style="border-color: #cbd5e1;">
              <option value="">-- เลือกจำนวนสมาชิก --</option>
              <option value="0">0 คน</option>
              <option value="1">1 คน</option>
              <option value="2">2 คน</option>
              <option value="3">3 คน</option>
              <option value="4">4 คน</option>
              <option value="5">5 คน</option>
              <option value="6">6 คน</option>
              <option value="7">7 คน</option>
              <option value="8">8 คน</option>
              <option value="9">9 คน</option>
              <option value="10">10 คน</option>
            </select>
          </div>

          <!-- เด็ก (0–12 ปี) -->
          <div class="mb-3 form-group">
            <label for="members-children" class="block mb-1 font-medium" style="color: #334155;">
              เด็ก (0–12 ปี)
            </label>
            <select id="members-children"
                    class="w-full px-3 py-2 border rounded bg-white"
                    style="border-color: #cbd5e1;">
              <option value="">-- เลือกจำนวน --</option>
              <option value="0">0 คน</option>
              <option value="1">1 คน</option>
              <option value="2">2 คน</option>
              <option value="3">3 คน</option>
              <option value="4">4 คน</option>
              <option value="5">5 คน</option>
            </select>
          </div>

          <!-- ผู้สูงอายุ (60+) -->
          <div class="mb-3 form-group">
            <label for="members-elderly" class="block mb-1 font-medium" style="color: #334155;">
              ผู้สูงอายุ (60+)
            </label>
            <select id="members-elderly"
                    class="w-full px-3 py-2 border rounded bg-white"
                    style="border-color: #cbd5e1;">
              <option value="">-- เลือกจำนวน --</option>
              <option value="0">0 คน</option>
              <option value="1">1 คน</option>
              <option value="2">2 คน</option>
              <option value="3">3 คน</option>
              <option value="4">4 คน</option>
              <option value="5">5 คน</option>
            </select>
          </div>

          <!-- คนพิการ / ผู้ป่วยติดเตียง -->
          <div class="mb-3 form-group">
            <label for="members-disabled" class="block mb-1 font-medium" style="color: #334155;">
              คนพิการ / ผู้ป่วยติดเตียง
            </label>
            <select id="members-disabled"
                    class="w-full px-3 py-2 border rounded bg-white"
                    style="border-color: #cbd5e1;">
              <option value="">-- เลือกจำนวน --</option>
              <option value="0">0 คน</option>
              <option value="1">1 คน</option>
              <option value="2">2 คน</option>
              <option value="3">3 คน</option>
              <option value="4">4 คน</option>
              <option value="5">5 คน</option>
            </select>
          </div>

          <!-- หญิงตั้งครรภ์ -->
          <div class="mb-3 form-group">
            <label for="members-pregnant" class="block mb-1 font-medium" style="color: #334155;">
              หญิงตั้งครรภ์
            </label>
            <select id="members-pregnant"
                    class="w-full px-3 py-2 border rounded bg-white"
                    style="border-color: #cbd5e1;">
              <option value="">-- เลือกจำนวน --</option>
              <option value="0">0 คน</option>
              <option value="1">1 คน</option>
              <option value="2">2 คน</option>
              <option value="3">3 คน</option>
              <option value="4">4 คน</option>
              <option value="5">5 คน</option>
            </select>
          </div>

          <!-- Needs Section -->
          <div class="section-block">
            <h2 class="font-bold mb-0" style="color: #15803d; font-size: 1.1rem;">
              สิ่งที่ต้องการความช่วยเหลือ
            </h2>
          </div>

          <div class="mb-4">
            <label class="block mb-2 font-medium" style="color: #334155;">
              เลือกได้มากกว่า 1 รายการ <span style="color: #ef4444;">*</span>
            </label>

            <div class="space-y-1.5">
              <label class="flex items-center cursor-pointer p-2 rounded"
                     style="background-color: #f8fafc; border: 1px solid #e2e8f0;">
                <input type="checkbox" name="needs" value="อาหาร/น้ำดื่ม"
                       class="mr-2" style="width: 16px; height: 16px;">
                <span style="color: #475569;">อาหาร/น้ำดื่ม</span>
              </label>

              <label class="flex items-center cursor-pointer p-2 rounded"
                     style="background-color: #f8fafc; border: 1px solid #e2e8f0;">
                <input type="checkbox" name="needs" value="ยา/ของใช้จำเป็น"
                       class="mr-2" style="width: 16px; height: 16px;">
                <span style="color: #475569;">ยา/ของใช้จำเป็น</span>
              </label>

              <label class="flex items-center cursor-pointer p-2 rounded"
                     style="background-color: #f8fafc; border: 1px solid #e2e8f0;">
                <input type="checkbox" name="needs" value="เสื้อผ้า/ผ้าห่ม"
                       class="mr-2" style="width: 16px; height: 16px;">
                <span style="color: #475569;">เสื้อผ้า/ผ้าห่ม</span>
              </label>

              <label class="flex items-center cursor-pointer p-2 rounded"
                     style="background-color: #f8fafc; border: 1px solid #e2e8f0;">
                <input type="checkbox" name="needs" value="อาหารเด็ก/นมผง"
                       class="mr-2" style="width: 16px; height: 16px;">
                <span style="color: #475569;">อาหารเด็ก/นมผง</span>
              </label>

              <label class="flex items-center cursor-pointer p-2 rounded"
                     style="background-color: #f8fafc; border: 1px solid #e2e8f0;">
                <input type="checkbox" name="needs" value="ของใช้ผู้สูงอายุ"
                       class="mr-2" style="width: 16px; height: 16px;">
                <span style="color: #475569;">ของใช้ผู้สูงอายุ</span>
              </label>

              <label class="flex items-center cursor-pointer p-2 rounded"
                     style="background-color: #f8fafc; border: 1px solid #e2e8f0;">
                <input type="checkbox" id="other-needs-checkbox" name="needs" value="อื่นๆ"
                       class="mr-2" style="width: 16px; height: 16px;">
                <span style="color: #475569;">อื่นๆ</span>
              </label>

              <textarea id="other-needs-detail" rows="2"
                        class="w-full px-3 py-2 border rounded mt-1"
                        style="border-color: #cbd5e1; display: none;"
                        placeholder="ระบุรายละเอียด"></textarea>
            </div>

            <div id="needs-error" class="mt-1" style="color: #ef4444; display: none;">
              กรุณาเลือกอย่างน้อย 1 รายการ
            </div>
          </div>

          <!-- กล่องแสดงข้อความ error ตอนบันทึกฟอร์มไม่สำเร็จ -->
          <div id="form-error" class="mb-3 p-2 rounded"
               style="background-color: #fee2e2; color: #991b1b; display: none; font-size: 0.85rem;">
            เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง
          </div>

          <div class="flex gap-2">
            <button type="button" id="back-btn"
                    class="flex-1 py-2 px-3 rounded font-medium"
                    style="background-color: #e2e8f0; color: #475569;">
              ย้อนกลับ
            </button>
            <button type="submit" id="submit-btn"
                    class="flex-1 py-2 px-3 rounded font-medium"
                    style="background-color: #15803d; color: #ffffff;">
              ยืนยันการลงทะเบียน
            </button>
          </div>

        </form>
    </div>

  </div>

  <script>
    // ==========================
    //   Location (อำเภอ/ตำบล/รหัสไปรษณีย์)
    // ==========================
    let locationData = []; // เก็บข้อมูลจากชีท

    const districtInput = document.getElementById('district');
    const subdistrictInput = document.getElementById('subdistrict');
    const postalInput = document.getElementById('postal-code');

    const districtList = document.getElementById('district-list');
    const subdistrictList = document.getElementById('subdistrict-list');
    const postalList = document.getElementById('postal-list');

    // โหลดข้อมูลจาก Google Sheet ตอนหน้าเว็บพร้อม (ใช้ fetch เรียก Web App แทน google.script.run)
    window.addEventListener('load', function () {
      // ใส่ URL Web App ของคุณที่คืนข้อมูล location เป็น JSON
      const url = 'https://script.google.com/macros/s/AKfycbwPJgtSnPq-tudglPqdhUEMfIxvnQEEiRNdwyHaiHjzDEfpkZHnQZu8vXGtHZJRV4_S/exec?action=getLocationData';

      fetch(url)
        .then(function (res) {
          if (!res.ok) {
            throw new Error('HTTP status ' + res.status);
          }
          return res.json();
        })
        .then(function (data) {
          // data ควรจะเป็น array ของ object: [{ district, subdistrict, postal }, ...]
          if (Array.isArray(data)) {
            locationData = data;
          } else if (Array.isArray(data.data)) {
            // เผื่อ backend ห่อเป็น {data:[...]}
            locationData = data.data;
          } else {
            locationData = [];
          }

          console.log('locationData loaded:', locationData.length, 'records');
          buildAllDatalists(); // สร้าง datalist รอบแรก
        })
        .catch(function (err) {
          console.error('โหลดข้อมูลอำเภอ/ตำบล/รหัสไปรษณีย์ไม่สำเร็จ:', err);
        });
    });

    // สร้าง datalist จากข้อมูลทั้งหมดครั้งแรก
    function buildAllDatalists() {
      if (!Array.isArray(locationData) || locationData.length === 0) return;

      const districts = [...new Set(locationData.map(r => r.district).filter(Boolean))];
      setOptions(districtList, districts);

      const subdistricts = [...new Set(locationData.map(r => r.subdistrict).filter(Boolean))];
      setOptions(subdistrictList, subdistricts);

      const postals = [...new Set(locationData.map(r => r.postal).filter(Boolean))];
      setOptions(postalList, postals);
    }

    function setOptions(datalistElem, items) {
      if (!datalistElem) return;
      datalistElem.innerHTML = '';
      items.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        datalistElem.appendChild(opt);
      });
    }

    function filterLocationData() {
      if (!Array.isArray(locationData) || locationData.length === 0) return;

      const dVal = districtInput.value.trim().toLowerCase();
      const sVal = subdistrictInput.value.trim().toLowerCase();
      const pVal = postalInput.value.trim().toLowerCase();

      let filtered = locationData.filter(row => {
        const dMatch = !dVal || (row.district && row.district.toLowerCase().includes(dVal));
        const sMatch = !sVal || (row.subdistrict && row.subdistrict.toLowerCase().includes(sVal));
        const pMatch = !pVal || (row.postal && row.postal.toLowerCase().startsWith(pVal));
        return dMatch && sMatch && pMatch;
      });

      if (filtered.length === 0) {
        filtered = locationData;
      }

      const newDistricts = [...new Set(filtered.map(r => r.district).filter(Boolean))];
      const newSubdistricts = [...new Set(filtered.map(r => r.subdistrict).filter(Boolean))];
      const newPostals = [...new Set(filtered.map(r => r.postal).filter(Boolean))];

      // อัปเดต datalist ให้แคบลงตามข้อมูลที่ match
      setOptions(districtList, newDistricts);
      setOptions(subdistrictList, newSubdistricts);
      setOptions(postalList, newPostals);

      // ✅ เงื่อนไข auto-fill ใหม่:
      // ถ้า "เหลือค่าเดียว" ในคอลัมน์ไหน และช่องนั้นยังว่าง → เติมให้อัตโนมัติ

      // อำเภอ
      if (newDistricts.length === 1 && !dVal) {
        districtInput.value = newDistricts[0] || '';
      }

      // ตำบล
      if (newSubdistricts.length === 1 && !sVal) {
        subdistrictInput.value = newSubdistricts[0] || '';
      }

      // รหัสไปรษณีย์
      if (newPostals.length === 1 && !pVal) {
        postalInput.value = newPostals[0] || '';
      }
    }

    if (districtInput) {
  ['input', 'change'].forEach(evt => {
    districtInput.addEventListener(evt, filterLocationData);
  });
}
if (subdistrictInput) {
  ['input', 'change'].forEach(evt => {
    subdistrictInput.addEventListener(evt, filterLocationData);
  });
}
if (postalInput) {
  ['input', 'change'].forEach(evt => {
    postalInput.addEventListener(evt, filterLocationData);
  });
}

    // Home Page Logic
    const startRegisterBtn = document.getElementById('start-register-btn');

    if (startRegisterBtn) {
      startRegisterBtn.addEventListener('click', function () {
        document.getElementById('home-page').style.display = 'none';
        document.getElementById('pdpa-page').style.display = 'block';
      });
    }

    // PDPA Page Logic
    const consentCheckbox = document.getElementById('consent-checkbox');
    const consentBtn = document.getElementById('consent-btn');
    const pdpaError = document.getElementById('pdpa-error');
    const backHomeBtn = document.getElementById('back-home-btn');

    if (consentCheckbox && consentBtn && backHomeBtn) {
      // ตั้งค่าเริ่มต้น: ปุ่มเห็นแต่กดไม่ได้
      consentBtn.disabled = true;
      consentBtn.style.opacity = '0.5';
      consentBtn.style.cursor = 'not-allowed';
      consentBtn.style.backgroundColor = '#15803d';

      consentCheckbox.addEventListener('change', function () {
        if (this.checked) {
          consentBtn.disabled = false;
          consentBtn.style.opacity = '1';
          consentBtn.style.cursor = 'pointer';
          consentBtn.style.backgroundColor = '#15803d';
          pdpaError.style.display = 'none';
        } else {
          consentBtn.disabled = true;
          consentBtn.style.opacity = '0.5';
          consentBtn.style.cursor = 'not-allowed';
          consentBtn.style.backgroundColor = '#15803d';
        }
      }); 

      consentBtn.addEventListener('click', function () {
        if (consentCheckbox.checked) {
          document.getElementById('pdpa-page').style.display = 'none';
          document.getElementById('registration-page').style.display = 'block';
        } else {
          pdpaError.style.display = 'block';
        }
      });

      backHomeBtn.addEventListener('click', function () {
        pdpaError.style.display = 'none';
        document.getElementById('pdpa-page').style.display = 'none';
        document.getElementById('home-page').style.display = 'block';
      });
    }

    // Registration Page Logic
const backBtn = document.getElementById('back-btn');
const registrationForm = document.getElementById('registration-form');
const idCardInput = document.getElementById('id-card');
const phoneInput = document.getElementById('phone');          // ← เพิ่มตัวแปรนี้
const otherNeedsCheckbox = document.getElementById('other-needs-checkbox');
const otherNeedsDetail = document.getElementById('other-needs-detail');
const needsError = document.getElementById('needs-error');
const formError = document.getElementById('form-error');
const submitBtn = document.getElementById('submit-btn');

    if (backBtn) {
      backBtn.addEventListener('click', function () {
        document.getElementById('registration-page').style.display = 'none';
        document.getElementById('pdpa-page').style.display = 'block';
      });
    }

    // Format ID card input (x-xxxx-xxxxx-xx-x)
if (idCardInput) {
  idCardInput.addEventListener('input', function (e) {
    let value = e.target.value.replace(/[^0-9]/g, '');
    if (value.length > 13) value = value.substring(0, 13);

    let formatted = '';
    if (value.length > 0) formatted += value.substring(0, 1);
    if (value.length > 1) formatted += '-' + value.substring(1, 5);
    if (value.length > 5) formatted += '-' + value.substring(5, 10);
    if (value.length > 10) formatted += '-' + value.substring(10, 12);
    if (value.length > 12) formatted += '-' + value.substring(12, 13);

    e.target.value = formatted;
  });
}

// Format phone input (xxx-xxx-xxxx)
if (phoneInput) {
  phoneInput.addEventListener('input', function (e) {
    // เอาเฉพาะตัวเลข
    let value = e.target.value.replace(/[^0-9]/g, '');

    // จำกัดไม่เกิน 10 หลัก
    if (value.length > 10) value = value.substring(0, 10);

    let formatted = '';

    // 3 ตัวแรก
    if (value.length > 0) {
      formatted += value.substring(0, 3);
    }

    // ตัวที่ 4–6
    if (value.length > 3) {
      formatted += '-' + value.substring(3, 6);
    }

    // ตัวที่ 7–10
    if (value.length > 6) {
      formatted += '-' + value.substring(6, 10);
    }

    e.target.value = formatted;
  });
}

    // Show/hide "other" needs detail
    if (otherNeedsCheckbox && otherNeedsDetail) {
      otherNeedsCheckbox.addEventListener('change', function () {
        if (this.checked) {
          otherNeedsDetail.style.display = 'block';
        } else {
          otherNeedsDetail.style.display = 'none';
          otherNeedsDetail.value = '';
        }
      });
    }

    // Form submission (Google Apps Script)
    if (registrationForm && submitBtn) {
      registrationForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const needsCheckboxes = document.querySelectorAll('input[name="needs"]:checked');
        if (needsCheckboxes.length === 0) {
          needsError.style.display = 'block';
          return;
        }
        needsError.style.display = 'none';

        const needs = Array.from(needsCheckboxes)
          .map(cb => cb.value)
          .join(', ');

        const formData = {
          // ใช้ id ให้ตรงกับ input จริงในฟอร์ม
          name: document.getElementById('name').value.trim(),
          surname: document.getElementById('surname').value.trim(),

          age: document.getElementById('age').value.trim(),           // อายุ
          gender: document.getElementById('gender').value,            // เพศ

          id_card: document.getElementById('id-card').value.trim(),
          phone: document.getElementById('phone').value.trim(),

          contact_other: document.getElementById('contact-other').value.trim(), // ช่องทางติดต่ออื่น

          // ที่อยู่ (พื้นที่ประสบภัย)
          house_no: document.getElementById('house-no').value.trim(), // บ้านเลขที่
          village: document.getElementById('village').value.trim(),   // หมู่บ้าน/ชุมชน
          subdistrict: document.getElementById('subdistrict').value.trim(), // ตำบล
          district: document.getElementById('district').value.trim(),       // อำเภอ
          province: document.getElementById('province').value.trim(),       // จังหวัด
          postal_code: document.getElementById('postal-code').value.trim(), // รหัสไปรษณีย์

          // สถานะพื้นที่
          area_status: document.getElementById('area-status').value,

          // จำนวนสมาชิกในบ้าน
          members_total: document.getElementById('members-total').value,
          members_children: document.getElementById('members-children').value,
          members_elderly: document.getElementById('members-elderly').value,
          members_disabled: document.getElementById('members-disabled').value,
          members_pregnant: document.getElementById('members-pregnant').value,

          // สิ่งที่ต้องการความช่วยเหลือ
          needs: needs,
          other_needs: otherNeedsCheckbox && otherNeedsCheckbox.checked
            ? otherNeedsDetail.value.trim()
            : '',

          submitted_at: new Date().toISOString()
        };

        submitBtn.disabled = true;
        submitBtn.textContent = 'กำลังบันทึก...';
        submitBtn.style.opacity = '0.5';
        formError.style.display = 'none';

        // ใช้ Web App URL ตัวเดียวกับที่ใช้โหลด location (ต้องเป็น 1 บรรทัดเต็ม ห้ามมี ... หรือขึ้นบรรทัดใหม่กลาง URL)
        const saveUrl = 'https://script.google.com/macros/s/AKfycbwPJgtSnPq-tudglPqdhUEMfIxvnQEEiRNdwyHaiHjzDEfpkZHnQZu8vXGtHZJRV4_S/exec?action=saveRegistration';
        fetch(saveUrl, {
          method: 'POST',
          // ใช้ text/plain เพื่อไม่ให้ browser ส่ง preflight OPTIONS (แก้ปัญหา CORS / Failed to fetch)
          headers: {
            'Content-Type': 'text/plain;charset=utf-8'
          },
          body: JSON.stringify(formData)
        })
          .then(function (res) {
            if (!res.ok) {
              throw new Error('HTTP status ' + res.status);
            }
            return res.json();
          })
          .then(function (result) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ยืนยันการลงทะเบียน';
            submitBtn.style.opacity = '1';

            if (result && result.success) {
              document.getElementById('successPopup').style.display = 'flex';

              registrationForm.reset();
              if (otherNeedsDetail) {
                otherNeedsDetail.style.display = 'none';
              }

              document.getElementById('registration-page').style.display = 'none';
              document.getElementById('home-page').style.display = 'block';
            } else {
              formError.textContent = (result && result.message)
                ? result.message
                : 'เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง';
              formError.style.display = 'block';
            }
          })
          .catch(function (error) {
            console.error('Error saving registration:', error);
            submitBtn.disabled = false;
            submitBtn.textContent = 'ยืนยันการลงทะเบียน';
            submitBtn.style.opacity = '1';

            formError.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์: ' + error;
            formError.style.display = 'block';
          });
      });
    }

    // ปิด popup
    const popupCloseBtn = document.getElementById("popupCloseBtn");
    const successPopup = document.getElementById("successPopup");

    if (popupCloseBtn && successPopup) {
      popupCloseBtn.addEventListener("click", function () {
        successPopup.style.display = "none";
      });
    }
  </script>
</body>
</html>
